# Zig è¯­è¨€åŸºç¡€ï¼ˆè¯­æ³•å…¥é—¨ï¼‰

## ğŸš€ å¼€ç¯‡å¼•è¨€

æ¬¢è¿æ¥åˆ° Zig å•ç‰‡æœºæ•™ç¨‹çš„ç¬¬å››è¯¾ï¼

ä¸ŠèŠ‚è¯¾æˆ‘ä»¬åœ¨ STM32F407 ä¸ŠæˆåŠŸè¿è¡Œäº† LED é—ªçƒç¨‹åºï¼Œä½“éªŒäº† Zig åœ¨åµŒå…¥å¼å¼€å‘ä¸­çš„åº”ç”¨ã€‚æœ¬èŠ‚è¯¾å°†æ·±å…¥å­¦ä¹  Zig åŸºç¡€è¯­æ³•ï¼ŒæŒæ¡ç¼–ç¨‹æ ¸å¿ƒæ¦‚å¿µï¼Œä¸ºåç»­å¼€å‘æ‰“ä¸‹åŸºç¡€ã€‚

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚è¯¾çš„å­¦ä¹ ï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… æŒæ¡ Zig åŸºæœ¬æ•°æ®ç±»å‹
- âœ… ç†è§£å˜é‡å£°æ˜å’Œåˆå§‹åŒ–
- âœ… å­¦ä¹ æ§åˆ¶æµè¯­å¥ï¼ˆæ¡ä»¶ã€å¾ªç¯ç­‰ï¼‰
- âœ… äº†è§£å‡½æ•°å®šä¹‰å’Œè°ƒç”¨
- âœ… æŒæ¡æŒ‡é’ˆå’Œå†…å­˜æ“ä½œ
- âœ… ç†è§£é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… å­¦ä¹ ç¼–è¯‘æœŸç‰¹æ€§ï¼ˆcomptimeï¼‰

---

## ğŸ“š åŸºæœ¬è¯­æ³•å’Œæ•°æ®ç±»å‹

### 1.1 åŸºæœ¬æ•°æ®ç±»å‹

Zig æä¾›äº†ä¸°å¯Œçš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé€‚åˆåµŒå…¥å¼å¼€å‘çš„éœ€æ±‚ï¼š

| ç±»å‹ | å¤§å° | æè¿° |
|------|------|------|
| `u8` | 1å­—èŠ‚ | æ— ç¬¦å·8ä½æ•´æ•° |
| `u16` | 2å­—èŠ‚ | æ— ç¬¦å·16ä½æ•´æ•° |
| `u32` | 4å­—èŠ‚ | æ— ç¬¦å·32ä½æ•´æ•° |
| `u64` | 8å­—èŠ‚ | æ— ç¬¦å·64ä½æ•´æ•° |
| `i8` | 1å­—èŠ‚ | æœ‰ç¬¦å·8ä½æ•´æ•° |
| `i16` | 2å­—èŠ‚ | æœ‰ç¬¦å·16ä½æ•´æ•° |
| `i32` | 4å­—èŠ‚ | æœ‰ç¬¦å·32ä½æ•´æ•° |
| `i64` | 8å­—èŠ‚ | æœ‰ç¬¦å·64ä½æ•´æ•° |
| `f32` | 4å­—èŠ‚ | å•ç²¾åº¦æµ®ç‚¹æ•° |
| `f64` | 8å­—èŠ‚ | åŒç²¾åº¦æµ®ç‚¹æ•° |
| `bool` | 1å­—èŠ‚ | å¸ƒå°”å€¼ï¼ˆtrue/falseï¼‰ |
| `u1`-`u7` | 1ä½-7ä½ | æ— ç¬¦å·å°æ•´æ•° |
| `i1`-`i7` | 1ä½-7ä½ | æœ‰ç¬¦å·å°æ•´æ•° |

> å…¶ä¸­ `u1`-`u7` ä¸º Zig ç‰¹æœ‰æ•°æ®ç±»å‹ï¼Œå¤©ç”Ÿé€‚åˆåµŒå…¥å¼å¼€å‘ã€‚

### 1.2 å˜é‡å£°æ˜ä¸åˆå§‹åŒ–

Zig ä¸­å˜é‡ç”¨ `var` å£°æ˜ï¼Œå¸¸é‡ç”¨ `const` å£°æ˜ï¼š

```zig
// å£°æ˜å¹¶åˆå§‹åŒ–å˜é‡
var count: u32 = 0;
var voltage: f32 = 3.3;
var led_state: bool = false;

// å£°æ˜å¸¸é‡
const PI: f32 = 3.14159;
const MAX_COUNT: u32 = 100;
const LED_PIN: u8 = 13;
```

> ğŸ’¡ **æç¤º**ï¼šå»ºè®®ä½¿ç”¨ `const` å£°æ˜å›ºå®šå€¼ï¼Œå¦‚å¼•è„šå·ã€å¯„å­˜å™¨åœ°å€ç­‰ï¼Œä»¥æé«˜ä»£ç å¯è¯»æ€§å’Œå®‰å…¨æ€§ã€‚

#### 1.2.1 ç±»å‹å£°æ˜

Zig æ”¯æŒæ˜¾å¼ç±»å‹å£°æ˜ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ï¼š

```zig
// æ˜¾å¼æŒ‡å®šç±»å‹
var x: i32 = 42;     // i32ç±»å‹
var y: f64 = 3.14;   // f64ç±»å‹
var z: bool = true;  // boolç±»å‹
```

> ğŸ’¡ **æç¤º**ï¼šåœ¨ Zig ä¸­ï¼Œæ•´æ•°å­—é¢é‡çš„é»˜è®¤ç±»å‹æ˜¯ `comptime_int`ï¼Œæµ®ç‚¹æ•°å­—é¢é‡çš„é»˜è®¤ç±»å‹æ˜¯ `comptime_float`ã€‚ä¸ºäº†é¿å…ç¼–è¯‘é”™è¯¯ï¼Œå»ºè®®åœ¨å£°æ˜å˜é‡æ—¶æ˜¾å¼æŒ‡å®šç±»å‹ï¼Œæˆ–è€…ä½¿ç”¨ `@as` è¿›è¡Œç±»å‹è½¬æ¢ï¼š

```zig
// ä½¿ç”¨ @as è¿›è¡Œç±»å‹è½¬æ¢
var x = @as(i32, 42);
var y = @as(f64, 3.14);
```

---

## ğŸ”§ æ§åˆ¶æµè¯­å¥

### 2.1 æ¡ä»¶è¯­å¥

Zig çš„æ¡ä»¶è¯­å¥ä½¿ç”¨ `if` å…³é”®å­—ï¼Œæ”¯æŒ `else if` å’Œ `else` åˆ†æ”¯ï¼š

```zig
if (temperature > 25) {
    // æ¸©åº¦è¿‡é«˜ï¼Œæ‰§è¡Œé™æ¸©æ“ä½œ
    activate_cooling();
} else if (temperature < 10) {
    // æ¸©åº¦è¿‡ä½ï¼Œæ‰§è¡Œå‡æ¸©æ“ä½œ
    activate_heating();
} else {
    // æ¸©åº¦é€‚å®œï¼Œä¿æŒå½“å‰çŠ¶æ€
    maintain_temperature();
}
```

### 2.2 å¾ªç¯è¯­å¥

Zig æä¾›äº†å¤šç§å¾ªç¯è¯­å¥ï¼š

#### 2.2.1 while å¾ªç¯

```zig
// åŸºæœ¬ while å¾ªç¯
var i: u32 = 0;
while (i < 10) : (i += 1) {
    // æ‰§è¡Œå¾ªç¯ä½“
    println("Count: {}", .{i});
}

// æ— é™å¾ªç¯
while (true) {
    // æ‰§è¡Œå¾ªç¯ä½“
    blink_led();
}
```

#### 2.2.2 for å¾ªç¯

`for` å¾ªç¯ç”¨äºéå†æ•°ç»„æˆ–åˆ‡ç‰‡ï¼š

```zig
const values = [_]u32{ 1, 2, 3, 4, 5 };

for (values) |value| {
    println("Value: {}", .{value});
}

// å¸¦ç´¢å¼•çš„éå†
for (values, 0..) |value, index| {
    println("Index {}: Value {}", .{index, value});
}
```

---

## ğŸ“ å‡½æ•°å®šä¹‰ä¸è°ƒç”¨

### 3.1 åŸºæœ¬å‡½æ•°å®šä¹‰

åœ¨ Zig ä¸­ï¼Œå‡½æ•°ä½¿ç”¨ `fn` å…³é”®å­—å®šä¹‰ï¼š

```zig
// åŸºæœ¬å‡½æ•°å®šä¹‰
fn add(a: i32, b: i32) i32 {
    return a + b;
}

// æ— è¿”å›å€¼å‡½æ•°
fn blink_led() void {
    // å®ç°LEDé—ªçƒé€»è¾‘
}

// noreturn å‡½æ•°ï¼ˆæ°¸ä¸è¿”å›ï¼‰
fn error_handler() noreturn {
    while (true) {
        // é”™è¯¯å¤„ç†é€»è¾‘
    }
}
```

#### 3.1.1 å‡½æ•°å‚æ•°ä¼ é€’

Zig ä¸­å‡½æ•°å‚æ•°é»˜è®¤æ˜¯å€¼ä¼ é€’ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æŒ‡é’ˆå®ç°å¼•ç”¨ä¼ é€’ï¼š

```zig
// å€¼ä¼ é€’
fn increment_value(value: u32) u32 {
    return value + 1;
}

// å¼•ç”¨ä¼ é€’ï¼ˆä½¿ç”¨æŒ‡é’ˆï¼‰
fn increment_pointer(value: *u32) void {
    value.* += 1;
}
```

### 3.2 å‡½æ•°è°ƒç”¨

```zig
// è°ƒç”¨å‡½æ•°
const result = add(10, 20);
println("Result: {}", .{result});

// è°ƒç”¨æ— è¿”å›å€¼å‡½æ•°
blink_led();
```

---

## ğŸ“ æŒ‡é’ˆå’Œå†…å­˜æ“ä½œ

### 4.1 æŒ‡é’ˆåŸºç¡€

Zig ä¸­çš„æŒ‡é’ˆä½¿ç”¨ `*` ç¬¦å·è¡¨ç¤ºï¼Œæ”¯æŒä¸åŒçš„æŒ‡é’ˆç±»å‹ï¼š

```zig
// å¯å˜æŒ‡é’ˆ
var x: u32 = 42;
var x_ptr: *u32 = &x;

// å¸¸é‡æŒ‡é’ˆ
const y: u32 = 100;
var y_ptr: *const u32 = &y;

// æŒ‡é’ˆè§£å¼•ç”¨
x_ptr.* = 99;  // ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å€¼
println("x: {}", .{x_ptr.*});
```

### 4.2 å†…å­˜æ“ä½œå‡½æ•°

Zig æä¾›äº†å†…ç½®çš„å†…å­˜æ“ä½œå‡½æ•°ï¼š

```zig
// å†…å­˜æ¸…é›¶
@memset(dest, 0, size);

// å†…å­˜å¤åˆ¶
@memcpy(dest, src, size);

// å†…å­˜æ¯”è¾ƒ
const is_equal = @memcmp(a, b, size) == 0;
```

---

## ğŸ“¦ ç»“æ„ä½“

### 5.1 ç»“æ„ä½“å®šä¹‰

Zig ä¸­çš„ç»“æ„ä½“ä½¿ç”¨ `struct` å…³é”®å­—å®šä¹‰ï¼Œç”¨äºç»„åˆå¤šä¸ªä¸åŒç±»å‹çš„å­—æ®µï¼š

```zig
// åŸºæœ¬ç»“æ„ä½“å®šä¹‰
const Point = struct {
    x: i32,
    y: i32,
};

// å¸¦æ–¹æ³•çš„ç»“æ„ä½“
const Rectangle = struct {
    width: u32,
    height: u32,
    
    // ç»“æ„ä½“æ–¹æ³•
    pub fn area(self: *const @This()) u32 {
        return self.width * self.height;
    }
    
    pub fn perimeter(self: *const @This()) u32 {
        return 2 * (self.width + self.height);
    }
};
```

### 5.2 ç»“æ„ä½“åˆå§‹åŒ–

ç»“æ„ä½“å¯ä»¥é€šè¿‡å­—æ®µååˆå§‹åŒ–ï¼š

```zig
// ç›´æ¥åˆå§‹åŒ–
const p1 = Point{ .x = 10, .y = 20 };

// ç»“æ„ä½“æ–¹æ³•è°ƒç”¨
var rect = Rectangle{ .width = 100, .height = 50 };
const area = rect.area();
const perimeter = rect.perimeter();
```

---

## ğŸ› ï¸ å¯„å­˜å™¨æ“ä½œå’Œ GPIO æ§åˆ¶

### 6.1 å¯„å­˜å™¨æ“ä½œåŸºç¡€

#### 6.1.1 ä½¿ç”¨ç»“æ„ä½“è¡¨ç¤ºå¯„å­˜å™¨

åœ¨åµŒå…¥å¼å¼€å‘ä¸­ï¼Œç»“æ„ä½“å¸¸ç”¨äºè¡¨ç¤ºå¯„å­˜å™¨ç»„æˆ–ç¡¬ä»¶é…ç½®ï¼Œè¿™ä½¿å¾—å¯„å­˜å™¨æ“ä½œæ›´åŠ ç›´è§‚å’Œç±»å‹å®‰å…¨ï¼š

```zig
// å¯„å­˜å™¨ç»“æ„ä½“
const GPIO = struct {
    MODER: u32,    // æ¨¡å¼å¯„å­˜å™¨
    OTYPER: u16,   // è¾“å‡ºç±»å‹å¯„å­˜å™¨
    OSPEEDR: u32,  // è¾“å‡ºé€Ÿåº¦å¯„å­˜å™¨
    PUPDR: u32,    // ä¸Šæ‹‰ä¸‹æ‹‰å¯„å­˜å™¨
    IDR: u16,      // è¾“å…¥æ•°æ®å¯„å­˜å™¨
    ODR: u16,      // è¾“å‡ºæ•°æ®å¯„å­˜å™¨
    BSRR: u32,     // ä½è®¾ç½®/æ¸…é™¤å¯„å­˜å™¨
};

// ä½¿ç”¨ç»“æ„ä½“è®¿é—®å¯„å­˜å™¨
const GPIOA = @as(*volatile GPIO, @ptrFromInt(0x40020000));
GPIOA.MODER |= 0x00000003;  // è®¾ç½® PA0 ä¸ºè¾“å‡ºæ¨¡å¼
GPIOA.ODR |= 0x0001;        // ç½®ä½ PA0
```

#### 6.1.2 å¯„å­˜å™¨æ“ä½œè¯­æ³•

åœ¨ Zig ä¸­ï¼Œå¯„å­˜å™¨æ“ä½œé€šå¸¸é€šè¿‡æŒ‡é’ˆå®ç°ï¼š

- **å¯„å­˜å™¨åœ°å€å®šä¹‰**ï¼šä½¿ç”¨ `const` å£°æ˜å¯„å­˜å™¨åŸºåœ°å€
- **æŒ‡é’ˆç±»å‹è½¬æ¢**ï¼šä½¿ç”¨ `@as(*volatile T, @ptrFromInt(address))` å°†åœ°å€è½¬æ¢ä¸ºæŒ‡é’ˆ
- **å¯„å­˜å™¨è®¿é—®**ï¼šé€šè¿‡æŒ‡é’ˆçš„è§£å¼•ç”¨æ“ä½œ `.*` è¯»å–æˆ–å†™å…¥å¯„å­˜å™¨å€¼
- **ä½æ“ä½œ**ï¼šä½¿ç”¨ä½è¿ç®—ç¬¦ï¼ˆ`|`ã€`&`ã€`^`ã€`<<`ã€`>>`ï¼‰ä¿®æ”¹å¯„å­˜å™¨çš„ç‰¹å®šä½

### 6.2 å‚è€ƒç¤ºä¾‹

è¯¦ç»†çš„å¯„å­˜å™¨æ“ä½œå’Œ GPIO æ§åˆ¶ç¤ºä¾‹è¯·å‚è€ƒç¬¬3èŠ‚æ•™ç¨‹ï¼ˆ`03-quick-mcu-run/quick-mcu-run.md`ï¼‰ä¸­çš„ LED é—ªçƒç¨‹åºï¼Œå…¶ä¸­åŒ…å«äº†å®Œæ•´çš„å¯„å­˜å™¨æ“ä½œå’Œ GPIO æ§åˆ¶å®ç°ã€‚

---

## âŒ é”™è¯¯å¤„ç†

### 7.1 é”™è¯¯ç±»å‹å®šä¹‰

Zig ä½¿ç”¨æšä¸¾ç±»å‹å®šä¹‰é”™è¯¯ï¼š

```zig
// å®šä¹‰é”™è¯¯ç±»å‹
const Error = error{
    InvalidValue,
    Timeout,
    HardwareFailure,
};
```

### 7.2 é”™è¯¯è¿”å›ä¸å¤„ç†

```zig
// è¿”å›é”™è¯¯çš„å‡½æ•°
fn read_sensor() Error!u16 {
    // æ¨¡æ‹Ÿä¼ æ„Ÿå™¨è¯»å–å¤±è´¥
    if (sensor_failed) {
        return Error.HardwareFailure;
    }
    
    // æˆåŠŸè¯»å–ï¼Œè¿”å›å€¼
    return sensor_value;
}

// å¤„ç†é”™è¯¯
const result = read_sensor() catch |err| {
    // é”™è¯¯å¤„ç†é€»è¾‘
    println("Error: {}", .{err});
    return err;
};

// ä½¿ç”¨é”™è¯¯
println("Sensor value: {}", .{result});
```

---

## âš¡ ç¼–è¯‘æœŸç‰¹æ€§ï¼ˆcomptimeï¼‰

### 8.1 ç¼–è¯‘æœŸå¸¸é‡

```zig
// ç¼–è¯‘æœŸè®¡ç®—
const MAX_BUFFER_SIZE = comptime calculate_max_size();

// ç¼–è¯‘æœŸæ–­è¨€
comptime {
    if (MAX_BUFFER_SIZE > 1024) {
        @compileError("Buffer size too large");
    }
}
```

### 8.2 ç¼–è¯‘æœŸå‡½æ•°

```zig
// ç¼–è¯‘æœŸå‡½æ•°
fn comptime calculate_array_size(comptime T: type) comptime_int {
    return @sizeOf(T) * 16;
}

// ä½¿ç”¨ç¼–è¯‘æœŸå‡½æ•°
const Buffer = [calculate_array_size(u8)]u8;
```

---

## ğŸ”¨ ç¼–è¯‘ç¤ºä¾‹ä»£ç 

### 9.1 ç¼–è¯‘åŸºæœ¬è¯­æ³•ç¤ºä¾‹

ç¤ºä¾‹ä»£ç å·²æäº¤åˆ°ä»“åº“ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨ `example-project/src/` ç›®å½•ä¸‹æ‰¾åˆ°å®Œæ•´çš„ç¤ºä¾‹ä»£ç ã€‚

```bash
cd example-project
zig build-exe src/basics.zig -O ReleaseSmall
```

---

## ğŸ“¢ ä¸‹èŠ‚é¢„å‘Š

æ­å»º Zig MCU å•æ­¥è°ƒè¯•ç¯å¢ƒï¼ˆåŸºäºVSCode + ST-Link + pyocdï¼‰

---

*å…³æ³¨æˆ‘ä»¬ï¼Œè·å–æ›´å¤š Zig åµŒå…¥å¼å¼€å‘æ•™ç¨‹ï¼*

*å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€è®¨è®º~*
